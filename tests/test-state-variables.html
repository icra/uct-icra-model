<!doctype html><html><head>
  <meta charset=utf8>
  <title>State variables</title>
  <style>
    @import url('https://fonts.googleapis.com/css?family=Roboto+Mono:400,700|Roboto:300,400,700');
    body {
      font-family: 'Roboto', verdana;
      color: #5C5C5C;
    }

    table{ border-collapse:collapse}
    table td.unit{font-size:smaller;}

    input[type=number]{
      width:70px;
      text-align:right;
    }

    fieldset {
      border-width:1px;
    }
  </style>
  <script src=format.js></script>
</head><body>
<div style="display:flex;justify-content:space-between;border-bottom:1px solid #ccc;margin-bottom:4px">
  <h3>
    State variables backend testing
    <button onclick=window.location.reload()>Reset all</button>
  </h3>
  <div>
    Source code: 
    <a href="https://github.com/icra/ecoadvisor/blob/master/state-variables.js" target=_blank>state-variables.js</a>
  </div>
</div>

<div style="display:flex;">
  <!--inputs - state variables-->
  <div>
    <div>1. State variables</div><br>
    <table id=inputs border=1 style=width:100%></table>

    <!--mass ratios-->
    <div style=font-size:smaller;margin-top:8px>
      <div>Mass ratios</div>
      <table id=mass_ratios border=1 style=width:100%></table>
    </div>
  </div>

  <!--totals and fractionation-->
  <div style="border-left:1px solid #ccc;margin-left:8px;padding:0px 4px">
    <div>2. Totals &amp; fractionation (mg/L)</div><br>
    <table id=outputs border=1></table>
  </div>

  <!--techs-->
  <div style="border-left:1px solid #ccc;margin-left:8px;padding:0px 4px" id=techs>
    <div>3. Apply technologies</div><br>
    <style>
      /*units*/
      #techs fieldset table td:nth-child(3){
        font-size:smaller;
      }
      /*apply buttons*/
      #techs button {
        background:lightgreen;
      }
      #techs fieldset {
        margin-bottom:8px;
      }
    </style>

    <fieldset id=primary_settler>
      <legend><a href="//github.com/icra/ecoadvisor/blob/master/primary-settler.js" target=_blank>Primary settler</a></legend>
      <table border=1>
        <tr><td>removal BPO<td><input id=removal_BPO type=number value=57.4257><td class=unit>%
        <tr><td>removal UPO<td><input id=removal_UPO type=number value=86.6667><td class=unit>%
        <tr><td>removal iSS<td><input id=removal_iSS type=number value=66>     <td class=unit>%
      </table>
      <button onclick="apply_pst();this.disabled=true">Apply</button>
      <script>
        function apply_pst(){
          let removal_BPO = parseFloat(document.querySelector('#removal_BPO').value);
          let removal_UPO = parseFloat(document.querySelector('#removal_UPO').value);
          let removal_iSS = parseFloat(document.querySelector('#removal_iSS').value);
          let results = sv.primary_settler(removal_BPO, removal_UPO, removal_iSS);
          redisplay();
          document.querySelector('#primary_settler').appendChild((function(){
            let div=document.createElement('div');
            div.style.fontSize='smaller';
            div.innerHTML="Primary Settler("+removal_BPO+","+removal_UPO+","+removal_iSS+") applied";

            let info=document.createElement('table');
            //info.style.display='none';
            Object.keys(results).forEach(key=>{
              let newRow=info.insertRow(-1);
              newRow.insertCell(-1).innerHTML=key;
              newRow.insertCell(-1).innerHTML=format(results[key].value);
              newRow.insertCell(-1).innerHTML=results[key].unit;
              newRow.setAttribute('title',results[key].descr);
            });

            let info_btn=document.createElement('button');
            info_btn.style.display='block';
            info_btn.innerHTML="Show/Hide Info";
            info_btn.onclick=function(){
              info.style.display=info.style.display=='none'?'':'none';
            };

            div.appendChild(info_btn);
            div.appendChild(info);
            return div;
          })());
        }
      </script>
    </fieldset>
  </div>
</div>

<!--app logic-->
<script src="../utils.js"></script>
<script src="../state-variables.js"></script>
<script src="../primary-settler.js"></script>
<script>
  /*Frontend connection with backend*/
  //initialize state variables (global variable)
  let sv=new State_Variables();
  {//populate tables
    //populate state variables table
    let inputs=document.querySelector('table#inputs');
    Object.entries(sv.components).forEach(entry=>{
      let key=entry[0];
      let value=entry[1];
      let newRow=inputs.insertRow(-1);
      newRow.insertCell(-1).innerHTML=key;
      newRow.insertCell(-1).innerHTML="<input id="+key+" type=number min=0 onchange=sv.components."+key+"=parseFloat(this.value);redisplay()>";
      newRow.insertCell(-1).outerHTML="<td class=unit>mg/L";
    });
    let mass_ratios=document.querySelector('table#mass_ratios');
    Object.entries(sv.mass_ratios).forEach(entry=>{
      let key=entry[0];
      let value=entry[1];
      let newRow=mass_ratios.insertRow(-1);
      newRow.insertCell(-1).innerHTML=key;
      newRow.insertCell(-1).innerHTML=value;
    });
  }

  //redisplay inputs and results
  function redisplay(){
    //redisplay inputs
    Object.keys(sv.components).forEach(key=>{
      let value=sv.components[key];
      document.getElementById(key).value=value;
    });

    //redisplay outputs
    let outputs = document.querySelector('#outputs');
    outputs.innerHTML="";
    let results = sv.compute_totals();
    Object.keys(results).forEach(key=>{
      let newRow=outputs.insertRow(-1);
      let value = results[key];
      if(typeof(value)=='number'){
        newRow.insertCell(-1).innerHTML=key;
        newRow.insertCell(-1).innerHTML=format(value);
      }else{
        newRow.insertCell(-1).innerHTML=key;
        let newCell=newRow.insertCell(-1);
        let table=document.createElement('table');table.style.width="100%";table.setAttribute('border',1);
        newCell.appendChild(table);
        Object.keys(results[key]).forEach(k=>{
          let nr=table.insertRow(-1);
          Object.keys(results[key][k]).forEach(kk=>{
            let value=results[key][k][kk];
            nr.insertCell(-1).innerHTML=kk+": <small>"+format(value)+"</small>";
          });
        });
      }
    });
  }
  redisplay();

  //focus the first input element you find
  document.querySelector("input[type=number]").focus();
</script>
