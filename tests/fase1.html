<!doctype html><html><head><meta charset=utf8>
  <title>Phase 1</title>
  <style>
    @import url('https://fonts.googleapis.com/css?family=Roboto+Mono:400,700|Roboto:300,400,700');
    body{
      font-family: 'Roboto', verdana;
      color: #5C5C5C;
      overflow-y:scroll;
    }
    table{
      border-collapse:collapse;
      margin-bottom:5px;
    }
    td,th{
      border:1px solid #ccc;
    }
    input[type=number]{
      text-align:right;
    }

    .flex{ 
      display:flex; 
    }
    .unit{ font-size:smaller;}
    .number{ text-align:right; }
    [onclick]{cursor:pointer}
    .error{
      font-size:smaller;
      margin-left:1em;
    }

    #inputs #edar input[type=number], 
    #inputs #edar select, 
    #inputs #mass_ratios input, 
    #inputs #constants input{
      display:block;
      max-width:70px;
    }
    #inputs #influent input{
      display:block;
      max-width:50px;
    }

    #outputs #processes table{
      margin-right:3px;
    }
    #outputs #fractionation td.number{
      font-size:smaller;
    }
  </style>
</head><body>

<!--title-->
<div style="border-bottom:1px solid #ccc;margin-bottom:4px;justify-content:space-between" class=flex>
  <h3>
    <span id=title onclick>
      Phase 1: Influent &rarr; plant
    </span>
    <!--run button-->
    <button id=run style="font-size:22px;margin:5px 0px">RUN</button>
  </h3>
  <div style=font-size:smaller>
    <a target=_blank href="//github.com/icra/ecoadvisor">github</a>
  </div>
</div>

<!--main-->
<div class=flex>
  <!--inputs-->
  <div style="border-right:1px solid #ccc;padding-right:4px;margin-right:4px">
    <div><strong onclick=toggle_visibility("#inputs")>Inputs</strong></div>
    <div id=inputs>
      <!--influent--><div><code onclick=toggle_visibility('#influent',this)>[-] Influent inputs</code></div>
      <table id=influent><tr>
        <td title="Flowrate"                            >Q               <input type=number id=Q      value=25  ><span class=unit>ML/d</span>
        <td title="Volatile fatty acids"                >S<sub>VFA </sub><input type=number id=S_VFA  value=50  ><span class=unit>mg/L</span>
        <td title="Fermentable organics"                >S<sub>FBSO</sub><input type=number id=S_FBSO value=115 ><span class=unit>mg/L</span>
        <td title="Biodegradable particulate organics"  >X<sub>BPO </sub><input type=number id=X_BPO  value=440 ><span class=unit>mg/L</span>
        <td title="Unbiodegradable particulate organics">X<sub>UPO </sub><input type=number id=X_UPO  value=100 ><span class=unit>mg/L</span>
        <td title="Unbiodegradable soluble organics"    >S<sub>USO </sub><input type=number id=S_USO  value=45  ><span class=unit>mg/L</span>
        <td title="Inert suspended solids"              >X<sub>iSS </sub><input type=number id=X_iSS  value=60  ><span class=unit>mg/L</span>
        <td title="Free saline ammonia"                 >S<sub>NH4 </sub><input type=number id=S_FSA  value=39.1><span class=unit>mg/L</span>
        <td title="Orthophosphate (PO4)"                >S<sub>PO4 </sub><input type=number id=S_OP   value=7.28><span class=unit>mg/L</span>
        <td title="Nitrate (NO3), nitrite (NO2)"        >S<sub>NOx </sub><input type=number id=S_NOx  value=0   ><span class=unit>mg/L</span>
        <td title="OHOs" style="display:none"           >X<sub>OHO </sub><input type=number id=X_OHO  value=0   ><span class=unit>mg/L</span>
      </table> 

      <!--plant--><div><code onclick=toggle_visibility('#edar',this)>[-] Plant inputs</code></div>
      <table id=edar style=font-size:smaller>
        <tr>
          <td><label><input type=checkbox id=pst> Primary settler</label>
          <td>fw                    <span class=unit>(ø)</span> <input type=number id=fw          value=0.005  > 
          <td>removal<sub>BPO</sub> <span class=unit>(%)</span> <input type=number id=removal_BPO value=42.3352> 
          <td>removal<sub>UPO</sub> <span class=unit>(%)</span> <input type=number id=removal_UPO value=90.0500> 
          <td>removal<sub>iSS</sub> <span class=unit>(%)</span> <input type=number id=removal_iSS value=75.1250> 
        </tr><tr>
          <td rowspan=2><label><input type=checkbox id=as checked=true disabled> Activated sludge</label>
          <td>T          <span class=unit>(ºC)</span>           <input type=number id=T   value=16    >   
          <td>Vp         <span class=unit>(m<sup>3</sup>)</span><input type=number id=Vp  value=8473.3> 
          <td>Rs         <span class=unit>(d)</span>            <input type=number id=Rs  value=15    >   
          <td>RAS        <span class=unit>(ø)</span>            <input type=number id=RAS value=1.0   >   
          <td>waste from <select id=waste_from><option>reactor<option>sst</select>
        </tr><tr>
          <td>DSVI <span class=unit>(mL/gTSS)      </span><input type=number id=DSVI value=120>
          <td>A_ST <span class=unit>(m<sup>2</sup>)</span><input type=number id=A_ST value=30000>
          <td>fq   <span class=unit>(ø)            </span><input type=number id=fq   value=2.4>
        </tr><tr>
          <td><label><input type=checkbox id=nit> Nitrification</label>
          <td>SF  <span class=unit>(ø)</span>   <input type=number id=SF  value=1.25> 
          <td>fxt <span class=unit>(ø)</span>   <input type=number id=fxt value=0.39> 
          <td>DO  <span class=unit>(mg/L)</span><input type=number id=DO  value=2.0 > 
          <td>pH  <span class=unit>(ø)</span>   <input type=number id=pH  value=7.2 > 
        </tr><tr>
          <td><label><input type=checkbox id=dn> Denitrification</label>
          <td>IR                     <span class=unit>(ø)   </span><input type=number id=IR           value=5.4> 
          <td>DO<sub>RAS</sub>       <span class=unit>(mg/L)</span><input type=number id=DO_RAS       value=1.0> 
          <td>influent<sub>alk</sub> <span class=unit>(mg/L)</span><input type=number id=influent_alk value=250> 
        </tr><tr>
          <td><label><input type=checkbox id=cpr> Chemical P removal</label>
          <td>FeCl<sub>3</sub> <span class=unit>(kg/d)</span> <input type=number id=mass_FeCl3 value=3000>
        </tr>
      </table> 

      <!--mass ratios--><div><code onclick=toggle_visibility('#mass_ratios',this)>[+] Mass ratios</code></div>
      <table id=mass_ratios style=display:none>
        <tr><td><td>fcv<div class=unit>gCOD/gVSS<td>fC<div class=unit>gVSS/gC<td>fN<div class=unit>gVSS/gN<td>fP<div class=unit>gVSS/gP
        <tr><td>S<sub>VFA</sub>
          <td><input id=f_CV_VFA type=number value=1.0667 step=0.0001>
          <td><input id=f_C_VFA  type=number value=0.4000 step=0.1000>
          <td><input id=f_N_VFA  type=number value=0.0000 step=0.1000>
          <td><input id=f_P_VFA  type=number value=0.0000 step=0.1000>
        </tr>
        <tr><td>S<sub>FBSO</sub>
          <td><input id=f_CV_FBSO type=number value=1.4200 step=0.0100>
          <td><input id=f_C_FBSO  type=number value=0.4710 step=0.0010>
          <td><input id=f_N_FBSO  type=number value=0.0464 step=0.0001>
          <td><input id=f_P_FBSO  type=number value=0.0118 step=0.0001>
        <tr><td>X<sub>BPO</sub>
          <td><input id=f_CV_BPO type=number value=1.5230 step=0.0010>
          <td><input id=f_C_BPO  type=number value=0.4980 step=0.0010>
          <td><input id=f_N_BPO  type=number value=0.0323 step=0.0001>
          <td><input id=f_P_BPO  type=number value=0.0072 step=0.0001>
        </tr>
        <tr><td>X<sub>UPO</sub>
          <td><input id=f_CV_UPO type=number value=1.4810 step=0.0010>
          <td><input id=f_C_UPO  type=number value=0.5180 step=0.0010>
          <td><input id=f_N_UPO  type=number value=0.1000 step=0.1000>
          <td><input id=f_P_UPO  type=number value=0.0250 step=0.0010>
        </tr>
        <tr><td>S<sub>USO</sub>
          <td><input id=f_CV_USO type=number value=1.4930 step=0.0010>
          <td><input id=f_C_USO  type=number value=0.4980 step=0.0010>
          <td><input id=f_N_USO  type=number value=0.0366 step=0.0001>
          <td><input id=f_P_USO  type=number value=0.0000 step=0.1000>
        <tr><td>X<sub>OHO</sub>
          <td><input id=f_CV_OHO type=number value=1.4810 step=0.0010>
          <td><input id=f_C_OHO  type=number value=0.5180 step=0.0010>
          <td><input id=f_N_OHO  type=number value=0.1000 step=0.1000>
          <td><input id=f_P_OHO  type=number value=0.0250 step=0.0010>
        </tr>
      </table>

      <!--constants--><div><code onclick=toggle_visibility('#constants',this)>[+] Kinetic parameters</code></div>
      <table id=constants style=display:none>
        <tr><td colspan=3><code onclick="toggle_visibility('#constants #as',this)">[-] Activated sludge</code>
        <tbody id=as>
          <tr title="heterotrophic VSS/COD yield"                      ><td>YH                      <td><input id="YH"          type=number value=0.450 step=0.01 ><td class=unit>gVSS/gCOD
          <tr title="heterotrophic endogenous respiration rate at 20ºC"><td>bH                      <td><input id="bH"          type=number value=0.240 step=0.01 ><td class=unit>1/d
          <tr title="bH temperature correction factor"                 ><td>&theta;<sub>bH</sub>    <td><input id="theta_bH"    type=number value=1.029 step=0.001><td class=unit>ø
          <tr title="not degraded bCOD (FBSO)"                         ><td>k_v20                   <td><input id="k_v20"       type=number value=0.070 step=0.01 ><td class=unit>L/mgVSS·d
          <tr title="k_v20 temperature correction factor"              ><td>&theta;<sub>k_v20</sub> <td><input id="theta_k_v20" type=number value=1.035 step=0.001><td class=unit>ø
          <tr title="endogenous residue fraction"                      ><td>fH                      <td><input id="fH"          type=number value=0.200 step=0.1  ><td class=unit>ø
          <tr title="iSS content of OHOs"                              ><td>f_iOHO                  <td><input id="f_iOHO"      type=number value=0.150 step=0.01 ><td class=unit>giSS/gVSS
        </tbody>
        <tr><td colspan=3><code onclick="toggle_visibility('#constants #nit',this)">[-] Nitrification</code>
        <tbody id=nit>
          <tr title="autotrophic max specific growth rate at 20ºC"     ><td>µAm                  <td><input id="µAm"       type=number value=0.450 step=0.01 ><td class=unit>1/d
          <tr title="µAm temperature correction factor"                ><td>&theta;<sub>µAm</sub><td><input id="theta_µAm" type=number value=1.123 step=0.001><td class=unit>ø
          <tr title="autotrophic oxygen half saturation coefficient"   ><td>K_O                  <td><input id="K_O"       type=number value=0.400 step=0.1  ><td class=unit>mgO/L
          <tr title="autotrophic pH sensitivity coefficient"           ><td>&theta;<sub>pH</sub> <td><input id="theta_pH"  type=number value=2.350 step=0.01 ><td class=unit>ø
          <tr title="autotrophic pH inhibition Ki"                     ><td>Ki                   <td><input id="Ki"        type=number value=1.130 step=0.01 ><td class=unit>ø
          <tr title="autotrophic pH inhibition Kii"                    ><td>Kii                  <td><input id="Kii"       type=number value=0.300 step=0.1  ><td class=unit>ø
          <tr title="autotrophic pH inhibition Kmax"                   ><td>Kmax                 <td><input id="Kmax"      type=number value=9.500 step=0.1  ><td class=unit>ø
          <tr title="autotrophic VSS/FSA yield at 20ºC"                ><td>YA                   <td><input id="YA"        type=number value=0.100 step=0.1  ><td class=unit>gVSS/gFSA
          <tr title="ammonia half saturation coefficient at 20ºC"      ><td>Kn                   <td><input id="Kn"        type=number value=1.000 step=0.1  ><td class=unit>mg/L
          <tr title="Kn temperature correction factor"                 ><td>&theta;<sub>Kn</sub> <td><input id="theta_Kn"  type=number value=1.123 step=0.001><td class=unit>ø
          <tr title="autotrophic endogenous respiration rate at 20ºC"  ><td>bA                   <td><input id="bA"        type=number value=0.040 step=0.01 ><td class=unit>1/d
          <tr title="bA temperature correction factor"                 ><td>&theta;<sub>bA</sub> <td><input id="theta_bA"  type=number value=1.029 step=0.001><td class=unit>ø
        </tbody>
        <tr><td colspan=3><code onclick="toggle_visibility('#constants #dn',this)">[-] Denitrification</code>
        <tbody id=dn>
          <tr title="K denitrification rate 2 at 20ºC"                 ><td>K2_20                <td><input id="K2_20"     type=number value=0.101 step=0.001><td class=unit>gN/gVSS·d
          <tr title="K2_20 temperature correction factor"              ><td>&theta;<sub>K2</sub> <td><input id="theta_K2"  type=number value=1.080 step=0.001><td class=unit>ø
        </tbody>
      </table>
    </div>
  </div>

  <!--outputs-->
  <div>
    <div><strong onclick=toggle_visibility('#outputs')>Outputs</strong></div>
    <div id=outputs>
      <!--summaries-->
      <div>
        <code onclick="toggle_visibility('#outputs #summaries',this)">
          [-] Summary
        </code>
        <span>
          <label onclick=""><input type=radio name=summary_units value=both>         all </label>
          <label onclick=""><input type=radio name=summary_units value=conc checked> mg/L</label>
          <label onclick=""><input type=radio name=summary_units value=flux>         kg/d</label>
        </span>
      </div>
      <div id=summaries style="display:"></div>

      <!--fractionation-->
      <div>
        <code onclick="toggle_visibility('#outputs #fractionation',this)">
          [+] Fractionation
        </code>
      </div>
      <div id=fractionation style="display:none"></div>

      <!--process variables-->
      <div><code onclick="toggle_visibility('#outputs #processes',this)">[+] Process variables</code></div>
      <div id=processes class=flex style="flex-wrap:wrap;display:none"></div>

      <!--errors-->
      <div><code onclick="toggle_visibility('#outputs #errors',this)">[-] Warnings/Errors <span id=error_counter>0</span></code></div>
      <div id=errors style="display:">under development</div>

      <!--export-->
      <div><code onclick="toggle_visibility('#outputs #export',this)">[+] Export</code></div>
      <textarea id=export style="display:none;width:100%;height:200px"></textarea>
    </div>
  </div>
</div>

<!--gui decimal number formatter-->
<script src=format.js></script>

<!--load backend-->
<script src="../state-variables.js"></script>
<script src="../constants.js"></script>
<script src="../primary-settler.js"></script>
<script src="../chemical-P-removal.js"></script>
<script src="../capacity-estimation.js"></script>
<script src="../activated-sludge.js"></script>
<script src="../nitrification.js"></script>
<script src="../denitrification.js"></script>
<script src="../plant.js"></script>

<!--model backend and gui integration-->
<script>
  //GET inputs from URL
  let url=new URL(window.location.href);

  //iterate GET keys
  for(let pair of url.searchParams.entries()){
    let key = pair[0];
    let val = pair[1];
    let el  = document.querySelector(`#inputs #${key}`);
    if(el){ 
      if(el.type=='checkbox'){
        if(val=='true') el.checked=true;
      }else{
        //includes <input type=number> and <select id>
        el.value = val;
      }
    }
  }

  //execute model
  document.querySelector('button#run').addEventListener('click',function(){
    //get influent
    let influent=new State_Variables(
      parseFloat(document.querySelector('#influent #Q').value),
      parseFloat(document.querySelector('#influent #S_VFA').value),
      parseFloat(document.querySelector('#influent #S_FBSO').value),
      parseFloat(document.querySelector('#influent #X_BPO').value),
      parseFloat(document.querySelector('#influent #X_UPO').value),
      parseFloat(document.querySelector('#influent #S_USO').value),
      parseFloat(document.querySelector('#influent #X_iSS').value),
      parseFloat(document.querySelector('#influent #S_FSA').value),
      parseFloat(document.querySelector('#influent #S_OP').value),
      parseFloat(document.querySelector('#influent #S_NOx').value),
    );

    //read mass ratios from screen and modify influent
    ['CV','C','N','P'].forEach(c1=>{
      ['VFA','FBSO','BPO','UPO','USO','OHO'].forEach(c2=>{
        influent.mass_ratios[`f_${c1}_${c2}`] =
          parseFloat(document.querySelector(`#mass_ratios #f_${c1}_${c2}`).value);
      });
    });

    //read constants from DOM
    document.querySelectorAll('#inputs #constants input[id]').forEach(input=>{
      constants[input.id]=parseFloat(input.value);
    });

    //get plant configuration from DOM
    let conf={
      pst:document.querySelector('#edar #pst').checked,
      nit:document.querySelector('#edar #nit').checked,
      dn :document.querySelector('#edar #dn').checked,
      cpr:document.querySelector('#edar #cpr').checked,
    };

    //get plant parameters from DOM
    let parameters={
      fw          : parseFloat(document.querySelector('#edar #fw').value),
      removal_BPO : parseFloat(document.querySelector('#edar #removal_BPO').value),
      removal_UPO : parseFloat(document.querySelector('#edar #removal_UPO').value),
      removal_iSS : parseFloat(document.querySelector('#edar #removal_iSS').value),
      T           : parseFloat(document.querySelector('#edar #T').value),
      Vp          : parseFloat(document.querySelector('#edar #Vp').value),
      Rs          : parseFloat(document.querySelector('#edar #Rs').value),
      RAS         : parseFloat(document.querySelector('#edar #RAS').value),
      waste_from  :            document.querySelector('#edar #waste_from').value,
      mass_FeCl3  : parseFloat(document.querySelector('#edar #mass_FeCl3').value),
      DSVI        : parseFloat(document.querySelector('#edar #DSVI').value),
      A_ST        : parseFloat(document.querySelector('#edar #A_ST').value),
      fq          : parseFloat(document.querySelector('#edar #fq').value),
      SF          : parseFloat(document.querySelector('#edar #SF').value),
      fxt         : parseFloat(document.querySelector('#edar #fxt').value),
      DO          : parseFloat(document.querySelector('#edar #DO').value),
      pH          : parseFloat(document.querySelector('#edar #pH').value),
      IR          : parseFloat(document.querySelector('#edar #IR').value),
      DO_RAS      : parseFloat(document.querySelector('#edar #DO_RAS').value),
      influent_alk: parseFloat(document.querySelector('#edar #influent_alk').value),
    };

    //create new plant and run model
    let plant = new Plant(influent, conf, parameters);
    let run = plant.run();
    /*backend end-------*/

    /*GUI integration*/

    //dibuixa fractionation columnes
    (function draw_fractionation(){
      //recopila variables d'estat (per ordre)
      let svs = {};
      svs.Influent                      = plant.influent;         //state variables object
      if(conf.pst) svs.Primary_wastage  = run.primary.wastage;    //state variables object
      if(conf.pst) svs.Primary_effluent = run.primary.effluent;   //state variables object
      svs.Secondary_wastage             = run.secondary.wastage;  //state variables object
      svs.Secondary_effluent            = run.secondary.effluent; //state variables object

      if(Object.keys(svs).length==0)return;
      let div   = document.querySelector('div#fractionation');div.innerHTML=""; //buida div summaries
      let table = document.createElement('table');div.appendChild(table);       //crea nova taula
      let newRow=table.insertRow(-1);
      newRow.insertCell(-1).outerHTML="<td colspan=2>";

      //posa noms variables d'estat
      Object.keys(svs).forEach(nom=>{newRow.insertCell(-1).outerHTML="<td colspan=2 style=font-size:smaller stream>"+nom.replace('_','<br>');});

      //calcula tots els fraccionaments de cop
      let totals={};
      Object.entries(svs).forEach(([nom,sv])=>{totals[nom]=sv.totals;});

      //agafa el primer fraccionament per posar noms de les variables
      let primer_fraccionament=Object.values(totals).find(e=>e);

      //itera COD,TKN,TP,TOC,TSS
      Object.entries(primer_fraccionament).forEach(([key,fraccions])=>{
        let newRow = table.insertRow(-1);
        let newCell = newRow.insertCell(-1);
        newCell.innerHTML=key;                           //COD,TKN,TP,TOC,TSS
        newCell.rowSpan=Object.keys(fraccions).length+1; //bsCOD,usCOD,bpCOD,upCOD...

        //itera cada fraccions dins de cada key
        Object.keys(fraccions).forEach(fraction=>{
          let newRow=table.insertRow(-1);

          //posa la mateixa nomenclatura d'en George Ekama
          let nomenclatura={
            "FSA":"N<sub>a</sub>",
            "PO4":"PO<sub>4</sub>",
            "bCOD":"S<sub>b</sub>",
            "uCOD":"S<sub>u</sub>",
            "sCOD":"S<sub>s</sub>",
            "pCOD":"S<sub>p</sub>",
            "bsCOD":"S<sub>bs</sub>",
            "usCOD":"S<sub>us</sub>",
            "bpCOD":"S<sub>bp</sub>",
            "upCOD":"S<sub>up</sub>",
            "ON":"N<sub>o</sub>",
            "bON":"N<sub>ob</sub>",
            "uON":"N<sub>ou</sub>",
            "sON":"N<sub>os</sub>",
            "pON":"N<sub>op</sub>",
            "bsON":"N<sub>obs</sub>",
            "usON":"N<sub>ous</sub>",
            "bpON":"N<sub>obp</sub>",
            "upON":"N<sub>oup</sub>",
            "OP":"P<sub>o</sub>",
            "bOP":"P<sub>ob</sub>",
            "uOP":"P<sub>ou</sub>",
            "sOP":"P<sub>os</sub>",
            "pOP":"P<sub>op</sub>",
            "bsOP":"P<sub>obs</sub>",
            "usOP":"P<sub>ous</sub>",
            "bpOP":"P<sub>obp</sub>",
            "upOP":"P<sub>oup</sub>",
            "OC":"C<sub>o</sub>",
            "bOC":"C<sub>ob</sub>",
            "uOC":"C<sub>ou</sub>",
            "sOC":"C<sub>os</sub>",
            "pOC":"C<sub>op</sub>",
            "bsOC":"C<sub>obs</sub>",
            "usOC":"C<sub>ous</sub>",
            "bpOC":"C<sub>obp</sub>",
            "upOC":"C<sub>oup</sub>",
          }[fraction]||fraction;

          if(fraction=='total'){
            if(key=='COD') nomenclatura='S<sub>t</sub>';
            if(key=='TOC') nomenclatura='C<sub>t</sub>';
            if(key=='TKN') nomenclatura='N<sub>t</sub>';
            if(key=='TP' ) nomenclatura='P<sub>t</sub>';
          }
          if(fraction=='active'){
            if(key=='COD') nomenclatura='S<sub>OHO</sub>';
            if(key=='TOC') nomenclatura='C<sub>OHO</sub>';
            if(key=='TKN') nomenclatura='N<sub>OHO</sub>';
            if(key=='TP' ) nomenclatura='P<sub>OHO</sub>';
          }
          if(key=='TSS'){
            if(fraction=='total')  nomenclatura='X<sub>t</sub>';
            if(fraction=='iSS')    nomenclatura='X<sub>IO</sub>';
            if(fraction=='VSS')    nomenclatura='X<sub>v</sub>';
            if(fraction=='bVSS')   nomenclatura='X<sub>vb</sub>';
            if(fraction=='uVSS')   nomenclatura='X<sub>vu</sub>';
            if(fraction=='active') nomenclatura='X<sub>OHO</sub>';
          }

          newRow.insertCell(-1).innerHTML=nomenclatura;

          //itera variables d'estat
          Object.entries(svs).forEach(([nom,sv])=>{
            let mgL = totals[nom][key][fraction]; //concentració
            let kgd = sv.Q*mgL;                   //flux
            newRow.insertCell(-1).outerHTML=`<td class=number conc>${format(mgL)}</td>`;
            newRow.insertCell(-1).outerHTML=`<td class=number flux>${format(kgd)}</td>`;
          });
        });
      });
    })();

    //dibuixa summaries en columnes
    (function draw_summaries(){
      //recopila summaries variables d'estat (per ordre)
      let summaries = {};
      summaries.Influent                      = plant.influent.summary;
      if(conf.pst) summaries.Primary_wastage  = run.primary.wastage.summary;
      if(conf.pst) summaries.Primary_effluent = run.primary.effluent.summary;
      summaries.Secondary_wastage             = run.secondary.wastage.summary;
      summaries.Secondary_effluent            = run.secondary.effluent.summary;

      if(Object.keys(summaries).length==0)return;
      let div   = document.querySelector('div#summaries'); div.innerHTML=""; //buida div summaries
      let table = document.createElement('table');div.appendChild(table);    //crea nova taula
      let newRow = table.insertRow(-1);newRow.insertCell(-1).innerHTML="";   //posa els noms de les variables d'estat
      Object.keys(summaries).forEach(key=>{newRow.insertCell(-1).outerHTML="<td colspan=2 style=font-size:smaller stream>"+key.replace('_','<br>');});
      //itera keys del primer objecte (Q,COD,TKN...)
      Object.keys(Object.values(summaries)[0]).forEach(key=>{
        let newRow = table.insertRow(-1);
        if(key=="Q"){
          newRow.insertCell(-1).innerHTML=`${key} <span class=unit>(ML/d)</span>`;
        }else{
          newRow.insertCell(-1).innerHTML=`${key} <span unit class=unit>(mg/L, kg/d)</span>`;
        }
        //itera cada variable d'estat
        Object.entries(summaries).forEach(([name,sv])=>{
          if(key=="Q"){
            let Q = sv.Q;
            newRow.insertCell(-1).outerHTML=`<td class=number colspan=2 flow value=${Q}>${format(Q)}</td>`;
          }else{
            let conc = sv[key][0];
            let flux = sv[key][1];
            let conc_txt = format(conc);
            let flux_txt = format(flux);
            if(name=="River_end" && (key!="NH4" && key!="PO4")){ conc_txt = flux_txt = "<span style=color:#ccc>ø</span>"; }
            newRow.insertCell(-1).outerHTML=`<td class=number conc title=${conc}>${conc_txt}</td>`;
            newRow.insertCell(-1).outerHTML=`<td class=number flux title=${flux}>${flux_txt}</td>`;
          }
        });
      });
    })();

    //dibuixa process variables (pvs)
    (function draw_pvs(){
      //recopila process_variables
      let processes = document.querySelector('#processes'); processes.innerHTML="";
      let pvs = {};
                   pvs.Activated_sludge   = run.process_variables.as;
      if(conf.nit) pvs.Nitrification      = run.process_variables.nit;
      if(conf.dn)  pvs.Denitrification    = run.process_variables.dn;
      if(conf.cpr) pvs.Chemical_P_removal = run.process_variables.cpr;

      Object.entries(pvs).forEach(([key,pv])=>{
        //container pel key i la taula: <div><div>key</div><table></table></div>
        let div = document.createElement('div'); processes.appendChild(div);

        //nom tecnologia
        let nom = document.createElement('code'); div.appendChild(nom);
        nom.style.fontSize='small';
        nom.innerHTML=`${key.replace(/_/g,' ')}&nbsp;`;

        //taula process variables
        let table = document.createElement('table'); div.appendChild(table);
        Object.entries(pv).forEach(([key,obj])=>{
          let newRow = table.insertRow(-1);
          newRow.id=key;
          let value = obj.value;
          newRow.value=value;
          newRow.setAttribute('title',obj.descr);
          newRow.insertCell(-1).innerHTML=key;
          newRow.insertCell(-1).outerHTML=`<td class=number title='${value}'><small>${format(value)}</small>`;
          newRow.insertCell(-1).outerHTML="<td class=unit>"+obj.unit.prettifyUnit();
        });
      });
    })();

    //dibuixa errors
    (function draw_errors(errors){
      document.querySelector('#error_counter').innerHTML=errors.length ? `(<b>${errors.length}</b>)`:'(0)';
      let div=document.querySelector('#outputs #errors');
      div.innerHTML=errors.length?"":"<li class=error>no errors";
      errors.forEach(error=>{
        div.appendChild((function(){
          let li=document.createElement('li');
          li.classList.add('error');
          li.innerHTML=error;
          return li;
        })());
      });
    })(run.errors);

    //clica les unitats que toquen
    document.querySelector('input[name=summary_units]:checked').click();
  });

  //generate URL with current inputs
  document.querySelector('button#run').addEventListener('click',function(){
    let newUrl = url.origin + url.pathname + '?'; //new url with all current inputs
    //get <input> elements
    document.querySelectorAll('#inputs input[id]').forEach(input=>{
      if(input.type=='checkbox') input.value = input.checked;
      newUrl += `${input.id}=${input.value}&`;
    });
    //get <select> elements
    document.querySelectorAll('#inputs select[id]').forEach(select=>{
      newUrl += `${select.id}=${select.value}&`;
    });
    //delete last '&' character
    newUrl = newUrl.substring(0,newUrl.length-1);
    //write newUrl to GUI
    document.querySelector('#outputs #export').value=newUrl;
  });

  //select unit in summaries
  document.querySelectorAll('input[name=summary_units]').forEach(input=>{
    input.addEventListener('click',function(){
      let outputs = document.querySelector('#outputs');
      switch(this.value){
        case "conc": 
          outputs.querySelectorAll('td[conc]').forEach(td=>td.style.display='');
          outputs.querySelectorAll('td[flux]').forEach(td=>td.style.display='none');
          outputs.querySelectorAll('td[flow]').forEach(td=>td.colSpan=1);
          outputs.querySelectorAll('td[stream]').forEach(td=>td.colSpan=1);
          outputs.querySelectorAll('span[unit]').forEach(td=>td.innerHTML="(mg/L)");
          break;
        case "flux": 
          outputs.querySelectorAll('td[conc]').forEach(td=>td.style.display='none');
          outputs.querySelectorAll('td[flux]').forEach(td=>td.style.display='');
          outputs.querySelectorAll('td[flow]').forEach(td=>td.colSpan=1);
          outputs.querySelectorAll('td[stream]').forEach(td=>td.colSpan=1);
          outputs.querySelectorAll('span[unit]').forEach(td=>td.innerHTML="(kg/d)");
          break;
        case "both":
          outputs.querySelectorAll('td[conc]').forEach(td=>td.style.display='');
          outputs.querySelectorAll('td[flux]').forEach(td=>td.style.display='');
          outputs.querySelectorAll('td[flow]').forEach(td=>td.colSpan=2);
          outputs.querySelectorAll('td[stream]').forEach(td=>td.colSpan=2);
          outputs.querySelectorAll('span[unit]').forEach(td=>td.innerHTML="(mg/L, kg/d)");
          break;
      }
    });
  });

  //enter key listener: execute model
  document.querySelectorAll('#inputs input').forEach(input=>{
    input.addEventListener('keypress',function(e){
      if(e.key=="Enter"){
        document.querySelector('button#run').click();
      }
    }); 
  });

  //reset inputs clicking the title
  document.querySelector('#title').addEventListener('click',function(){window.location=url.origin+url.pathname;});

  //select text inside #export
  document.querySelector('#export').addEventListener('focus',function(){this.select();});

  //click run button
  document.querySelector('button#run').click();
</script>

<!--gui utils-->
<script>
  function toggle_visibility(selector,btn){
    let el=document.querySelector(selector);
    if(el)el.style.display=el.style.display=='none'?'':'none';
    if(btn){
      if(btn.innerHTML.search('[+]')+1){
        btn.innerHTML=btn.innerHTML.replace('[+]','[-]');
      }else if(btn.innerHTML.search('[-]')+1){
        btn.innerHTML=btn.innerHTML.replace('[-]','[+]');
      }
    }
  }
</script>
