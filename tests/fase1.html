<!doctype html><html><head>
  <meta charset=utf8>
  <title>Phase 1</title>
  <style>
    @import url('https://fonts.googleapis.com/css?family=Roboto+Mono:400,700|Roboto:300,400,700');
    body {
      font-family: 'Roboto', verdana;
      color: #5C5C5C;
    }
    table{
      border-collapse:collapse;
      margin-bottom:5px;
    }
    td,th {
      border:1px solid #ccc;
    }
    input[type=number]{
      text-align:right;
    }

    .flex{ 
      display:flex; 
    }
    .unit{ font-size:smaller;}
    .number{ text-align:right; }
    [onclick]{cursor:pointer}

    #influent input,
    #river input[type=number], 
    #degradation input
    {
      display:block;
      width:48px;
    }
    #river input[type=number]{
      width:60px;
    }
    #degradation input{
      width:70px;
    }
    #edar input{
      max-width:56px;
    }
    #processes table {
      margin-right:3px;
    }
  </style>
  <!--utils-->
  <script src=format.js></script>
</head><body>

<!--title-->
<div style="border-bottom:1px solid #ccc;margin-bottom:4px"><h3>Phase 1: Influent &rarr; plant &rarr; river</h3></div>

<!--main-->
<div class=flex>
  <!--inputs-->
  <div id=inputs style="border-right:1px solid #ccc;padding-right:4px;margin-right:4px"><div><strong>Inputs</strong></div>
    <!--influent--><div><code>Influent</code></div>
    <table id=influent><tr>
      <td title="Flowrate"                            >Q     <input type=number id=Q      value=25  ><span class=unit>ML/d</span>
      <td title="Volatile fatty acids"                >S_VFA <input type=number id=S_VFA  value=50  ><span class=unit>mg/L</span>
      <td title="Fermentable organics"                >S_FBSO<input type=number id=S_FBSO value=115 ><span class=unit>mg/L</span>
      <td title="Biodegradable particulate organics"  >X_BPO <input type=number id=X_BPO  value=440 ><span class=unit>mg/L</span>
      <td title="Unbiodegradable particulate organics">X_UPO <input type=number id=X_UPO  value=100 ><span class=unit>mg/L</span>
      <td title="Unbiodegradable soluble organics"    >S_USO <input type=number id=S_USO  value=45  ><span class=unit>mg/L</span>
      <td title="Inert suspended solids"              >X_iSS <input type=number id=X_iSS  value=60  ><span class=unit>mg/L</span>
      <td title="Free saline ammonia"                 >S_NH4 <input type=number id=S_FSA  value=39.1><span class=unit>mg/L</span>
      <td title="Orthophosphate (PO4)"                >S_PO4 <input type=number id=S_OP   value=7.28><span class=unit>mg/L</span>
      <td title="Nitrate (NO3), nitrite (NO2)"        >S_NOx <input type=number id=S_NOx  value=0   disabled><span class=unit>mg/L</span>
    </table> 

    <!--plant--><div><code>Plant</code></div>
    <table id=edar style=font-size:smaller>
      <tr>
        <td><label><input type=checkbox id=pst> Primary settler</label>
        <td>fw         <br><input type=number id=fw          value=0.005  > <span class=unit>ø</span>
        <td>removal_BPO<br><input type=number id=removal_BPO value=42.3352> <span class=unit>%</span>
        <td>removal_UPO<br><input type=number id=removal_UPO value=90.0500> <span class=unit>%</span>
        <td>removal_iSS<br><input type=number id=removal_iSS value=75.1250> <span class=unit>%</span>
      </tr><tr>
        <td><label><input type=checkbox id=as checked=true disabled> Activated sludge</label>
        <td>T         <br><input type=number id=T          value=16  >   <span class=unit>ºC</span>
        <td>Vp        <br><input type=number id=Vp         value=8473.3> <span class=unit>m<sup>3</sup></span>
        <td>Rs        <br><input type=number id=Rs         value=15  >   <span class=unit>d</span>
        <td>RAS       <br><input type=number id=RAS        value=1.0 >   <span class=unit>ø</span>
        <td>waste_from<br><select id=waste_from><option>reactor<option>sst</select>
      </tr><tr>
        <td><label><input type=checkbox id=nit> Nitrification</label>
        <td>SF <br><input type=number id=SF  value=1.25> <span class=unit>ø</span>
        <td>fxt<br><input type=number id=fxt value=0.39> <span class=unit>ø</span>
        <td>DO <br><input type=number id=DO  value=2.0 > <span class=unit>mg/L</span>
        <td>pH <br><input type=number id=pH  value=7.2 > <span class=unit>ø</span>
      </tr><tr>
        <td><label><input type=checkbox id=dn> Denitrification</label>
        <td>IR          <br><input type=number id=IR           value=5.4> <span class=unit>ø</span>
        <td>DO_RAS      <br><input type=number id=DO_RAS       value=1.0> <span class=unit>mg/L</span>
        <td>influent_alk<br><input type=number id=influent_alk value=250> <span class=unit>mg/L</span>
      </tr><tr>
        <td><label><input type=checkbox id=cpr> Chemical P removal</label>
        <td>mass_FeCl<sub>3</sub><br><input type=number id=mass_FeCl3 value=3000> <span class=unit>kg/d</span>
      </tr>
    </table> 

    <!--river--><div><code>River</code></div>
    <table id=river>
      <tr>
        <td><label><input type=checkbox id=active checked> on/off</label>
      </tr><tr>
        <td title="Amplada a llera mitjana">                wb<input type=number id=wb value=25.88>     <span class=unit>m</span>
        <td title="Amplada a bankful mitjana">              wt<input type=number id=wt value=62.274>    <span class=unit>m</span>
        <td title="Distància entre llera i bankful mitjana">Db<input type=number id=Db value=18.458414> <span class=unit>m</span>
        <td title="Pendent de la llera">                    S <input type=number id=S  value=0.0010055> <span class=unit>m/m</span>
        <td title="Coeficient de manning">                  n <input type=number id=n  value=0.0358>    <span class=unit>s/m<sup>1/3</sup></span>
        <td title="Longitud del tram">                      Li<input type=number id=Li value=2000>      <span class=unit>m</span>
        <td title="Fondària concreta">                      Di<input type=number id=Di value=0.6>       <span class=unit>m</span>
        <td title="Temperatura">                            Ti<input type=number id=Ti value=15>        <span class=unit>ºC</span>
      </tr><tr>
        <td title="Volatile fatty acids"                >S_VFA <input type=number id=S_VFA  value=0><span class=unit>mg/L</span>
        <td title="Fermentable organics"                >S_FBSO<input type=number id=S_FBSO value=0><span class=unit>mg/L</span>
        <td title="Biodegradable particulate organics"  >X_BPO <input type=number id=X_BPO  value=0><span class=unit>mg/L</span>
        <td title="Unbiodegradable particulate organics">X_UPO <input type=number id=X_UPO  value=0><span class=unit>mg/L</span>
        <td title="Unbiodegradable soluble organics"    >S_USO <input type=number id=S_USO  value=0><span class=unit>mg/L</span>
        <td title="Inert suspended solids"              >X_iSS <input type=number id=X_iSS  value=0><span class=unit>mg/L</span>
        <td title="Free saline ammonia"                 >S_NH4 <input type=number id=S_FSA  value=0><span class=unit>mg/L</span>
        <td title="Orthophosphate (PO4)"                >S_PO4 <input type=number id=S_OP   value=0><span class=unit>mg/L</span>
        <td title="Nitrate (NO3), nitrite (NO2)"        >S_NOx <input type=number id=S_NOx  value=0><span class=unit>mg/L</span>
      </tr>
    </table>

    <!--river--><div><code>River degradation</code></div>
    <table id=degradation>
      <tr id=NH4>
        <td>NH<sub>4</sub>
        <td>R20<input type=number id=R_20 value=0.0000005> <span class=unit>g/m<sup>2</sup>·min</span>
        <td>k  <input type=number id=k    value=1>         <span class=unit>mg/L</span>
      <tr id=PO4>
        <td>PO<sub>4</sub>
        <td>R20<input type=number id=R_20 value=0.0000005> <span class=unit>g/m<sup>2</sup>·min</span>
        <td>k  <input type=number id=k    value=1>         <span class=unit>mg/L</span>
      </tr>
    </table>

    <!--run button-->
    <div style=text-align:right><button id=run style="font-size:22px;margin:5px 0px">RUN</button></div>
  </div>

  <!--outputs-->
  <div id=outputs><div><strong>Outputs</strong></div>
    <!--summaries-->
    <div><code onclick="toggle_visibility('#outputs #summaries')">[+] Summaries</code></div>
    <div id=summaries style="display:"></div>

    <!--plant-->
    <div><code onclick="toggle_visibility('#outputs #processes')">[+] Plant process variables</code></div>
    <div id=processes class=flex style="flex-wrap:wrap;display:none"></div>

    <!--river-->
    <div><code onclick="toggle_visibility('#outputs #river')">[+] River</code></div>
    <div id=river style="display:none"></div>
  </div>
</div>

<!--load backend-->
<script src="../state-variables.js"></script>
<script src="../primary-settler.js"></script>
<script src="../activated-sludge.js"></script>
<script src="../nitrification.js"></script>
<script src="../denitrification.js"></script>
<script src="../chemical-P-removal.js"></script>
<script src="../tram.js"></script>

<!--execute model backend and gui integration-->
<script>
  //btn run click listener
  document.querySelector('button#run').addEventListener('click',function(){
    //get influent
    let influent=new State_Variables(
      parseFloat(document.querySelector('#influent #Q').value),
      parseFloat(document.querySelector('#influent #S_VFA').value),
      parseFloat(document.querySelector('#influent #S_FBSO').value),
      parseFloat(document.querySelector('#influent #X_BPO').value),
      parseFloat(document.querySelector('#influent #X_UPO').value),
      parseFloat(document.querySelector('#influent #S_USO').value),
      parseFloat(document.querySelector('#influent #X_iSS').value),
      parseFloat(document.querySelector('#influent #S_FSA').value),
      parseFloat(document.querySelector('#influent #S_OP').value),
      parseFloat(document.querySelector('#influent #S_NOx').value),
    );

    /*backend plant*/
    //get plant configuration
    let conf={
      pst:document.querySelector('#edar #pst').checked,
      nit:document.querySelector('#edar #nit').checked,
      dn :document.querySelector('#edar #dn').checked,
      cpr:document.querySelector('#edar #cpr').checked,
      river:document.querySelector('#river #active').checked,
    };

    //call primary settler
    let pst;
    if(conf.pst){
      pst = influent.primary_settler(
        parseFloat(document.querySelector('#edar #fw').value),
        parseFloat(document.querySelector('#edar #removal_BPO').value),
        parseFloat(document.querySelector('#edar #removal_UPO').value),
        parseFloat(document.querySelector('#edar #removal_iSS').value)
      );
    }else{ pst = { effluent:influent, wastage:null }; }

    //call AS+(NIT)+(DN)
    let as;
    if(conf.dn){
      as = pst.effluent.denitrification(
        parseFloat(document.querySelector('#edar #T').value),
        parseFloat(document.querySelector('#edar #Vp').value),
        parseFloat(document.querySelector('#edar #Rs').value),
        parseFloat(document.querySelector('#edar #RAS').value),
        document.querySelector('#edar #waste_from').value,
        parseFloat(document.querySelector('#edar #SF').value),
        parseFloat(document.querySelector('#edar #fxt').value),
        parseFloat(document.querySelector('#edar #DO').value),
        parseFloat(document.querySelector('#edar #pH').value),
        parseFloat(document.querySelector('#edar #IR').value),
        parseFloat(document.querySelector('#edar #DO_RAS').value),
        parseFloat(document.querySelector('#edar #influent_alk').value),
      );
    }else if(conf.nit){
      as = pst.effluent.nitrification(
        parseFloat(document.querySelector('#edar #T').value),
        parseFloat(document.querySelector('#edar #Vp').value),
        parseFloat(document.querySelector('#edar #Rs').value),
        parseFloat(document.querySelector('#edar #RAS').value),
        document.querySelector('#edar #waste_from').value,
        parseFloat(document.querySelector('#edar #SF').value),
        parseFloat(document.querySelector('#edar #fxt').value),
        parseFloat(document.querySelector('#edar #DO').value),
        parseFloat(document.querySelector('#edar #pH').value),
      );
    }else{
      as = pst.effluent.activated_sludge(
        parseFloat(document.querySelector('#edar #T').value),
        parseFloat(document.querySelector('#edar #Vp').value),
        parseFloat(document.querySelector('#edar #Rs').value),
        parseFloat(document.querySelector('#edar #RAS').value),
        document.querySelector('#edar #waste_from').value,
      );
    }

    //call CPR
    let cpr;
    if(conf.cpr){
      cpr = as.effluent.chemical_P_removal(
        parseFloat(document.querySelector('#edar #mass_FeCl3').value),
      );
      cpr.wastage = as.wastage;
    }else{ cpr = { effluent:as.effluent, wastage:as.wastage }; }

    /*backend riu*/
    //get tram upstream
    //syntax-----Tram(wb, wt, Db, S, n, Li, Di, Ti)
    let tram=new Tram(
      parseFloat(document.querySelector('#inputs #river #wb').value),
      parseFloat(document.querySelector('#inputs #river #wt').value),
      parseFloat(document.querySelector('#inputs #river #Db').value),
      parseFloat(document.querySelector('#inputs #river #S').value),
      parseFloat(document.querySelector('#inputs #river #n').value),
      parseFloat(document.querySelector('#inputs #river #Li').value),
      parseFloat(document.querySelector('#inputs #river #Di').value),
      parseFloat(document.querySelector('#inputs #river #Ti').value),
    );

    //get state variables
    Object.keys(tram.state_variables.components).forEach(key=>{
      tram.state_variables.set(
        key,
        parseFloat(document.querySelector(`#inputs #river #${key}`).value)
      );
    });

    //combina efluent depuradora i tram upstream
    let sv_mixed = tram.state_variables.combine(cpr.effluent);

    //aplica degradació al riu
    let deg = {
      R_20:{
        NH4:parseFloat(document.querySelector('#inputs #degradation #NH4 #R_20').value),
        PO4:parseFloat(document.querySelector('#inputs #degradation #PO4 #R_20').value),
      },
      k:{
        NH4:parseFloat(document.querySelector('#inputs #degradation #NH4 #k').value),
        PO4:parseFloat(document.querySelector('#inputs #degradation #PO4 #k').value),
      },
    }

    let sv_end = new State_Variables(
      sv_mixed.Q,
      0, //VFA
      0, //FBSO
      0, //BPO
      0, //UPO
      0, //USO
      0, //iSS
      tram.Mf(sv_mixed.components.S_FSA, deg.R_20.NH4, deg.k.NH4), //FSA
      tram.Mf(sv_mixed.components.S_OP,  deg.R_20.PO4, deg.k.PO4), //OP
      0, //NOx
    );
    /*backend end--------------------------------*/

    /*GUI integration*/
    //recopila summaries variables d'estat (per ordre)
    let svs = {};

    //afegeix summaries a "svs"
    svs.Influent = influent.summary;
    if(conf.pst) svs.Primary_wastage    = pst.wastage.summary;
    if(conf.pst) svs.Primary_effluent   = pst.effluent.summary;
                 svs.Secondary_wastage  = cpr.wastage.summary;
                 svs.Secondary_effluent = cpr.effluent.summary;

    //afegeix variables d'estat riu a "svs"
    if(conf.river){
      svs.River_upstream = tram.state_variables.summary;
      svs.River_mixed    = sv_mixed.summary;
      svs.River_end      = sv_end.summary;
    }

    //dibuixa summaries (svs) en columnes
    (function draw_summaries(svs){
      if(Object.keys(svs).length==0)return;
      let div = document.querySelector('div#summaries'); div.innerHTML=""; //buida div summaries
      let table = document.createElement('table');div.appendChild(table);  //crea nova taula
      let newRow = table.insertRow(-1);newRow.insertCell(-1).innerHTML=""; //posa els noms de les variables d'estat
      Object.keys(svs).forEach(key=>{newRow.insertCell(-1).outerHTML="<td colspan=2 style=font-size:smaller>"+key.replace('_','<br>');});
      //itera keys del primer objecte (Q,COD,TKN...)
      Object.keys(Object.values(svs)[0]).forEach(key=>{
        let newRow = table.insertRow(-1);
        newRow.insertCell(-1).innerHTML=`${key} <span class=unit>${key=="Q"?"(ML/d)":"(mg/L, kg/d)"}</span>`;
        //itera cada variable d'estat
        Object.entries(svs).forEach(([name,sv])=>{
          if(key=="Q"){
            newRow.insertCell(-1).outerHTML="<td class=number colspan=2>"+format(sv[key]);
          }else{
            let conc = format(sv[key][0]);
            let flux = format(sv[key][1]);
            if(name=="River_end" && (key!="NH4" && key!="PO4")){ conc = flux = "<span style=color:#ccc>ø</span>"; }
            newRow.insertCell(-1).outerHTML="<td class=number>"+conc;
            newRow.insertCell(-1).outerHTML=`<td class=number><small>${flux}</small>`;
          }
        });
      });
    })(svs);

    //recopila process_variables
    let processes = document.querySelector('#processes'); processes.innerHTML="";
    let pvs = {};
    if(conf.dn){
      pvs.Activated_sludge = as.as_process_variables;
      pvs.Nitrification    = as.nit_process_variables;
      pvs.Denitrification  = as.process_variables;
    }else if(conf.nit){
      pvs.Activated_sludge = as.as_process_variables;
      pvs.Nitrification    = as.process_variables;
    }else{
      pvs.Activated_sludge = as.process_variables;
    }
    if(conf.cpr){
      pvs.Chemical_P_removal = cpr.process_variables;
    };

    //dibuixa process variables (pvs)
    Object.entries(pvs).forEach(([key,pv])=>{
      let table = document.createElement('table'); processes.appendChild(table);
      table.insertRow(-1).innerHTML=key.replace(/_/g,' ');
      Object.entries(pv).forEach(([key,obj])=>{
        let newRow = table.insertRow(-1);
        newRow.setAttribute('title',obj.descr);
        newRow.insertCell(-1).innerHTML=key;
        newRow.insertCell(-1).outerHTML=`<td class=number><small>${format(obj.value)}</small>`;
        newRow.insertCell(-1).outerHTML="<td class=unit>"+obj.unit.prettifyUnit();
      });
    });

    //dibuixa les característiques del riu
    (function draw_river(){
      let river = document.querySelector('#outputs #river'); river.innerHTML="";
      let table = document.createElement('table'); river.appendChild(table);
      Object.entries(tram.resultats).forEach(([key,obj])=>{
        let newRow=table.insertRow(-1);
        newRow.setAttribute('title',obj.descr);
        newRow.insertCell(-1).innerHTML=key;
        newRow.insertCell(-1).outerHTML=`<td class=number><small>${format(obj.value)}</small>`;
        newRow.insertCell(-1).outerHTML="<td class=unit>"+obj.unit.prettifyUnit();
      });
    })();
  });

  //clica el botó RUN
  document.querySelector('button#run').click();
</script>

<!--gui utils-->
<script>
  function toggle_visibility(selector){
    let el=document.querySelector(selector);
    if(el)el.style.display=el.style.display=='none'?'':'none';
  }
</script>
