<!doctype html><html><head>
  <meta charset=utf8>
  <title>State variables</title>
  <style>
    @import url('https://fonts.googleapis.com/css?family=Roboto+Mono:400,700|Roboto:300,400,700');
    body {
      font-family: 'Roboto', verdana;
      color: #5C5C5C;
    }

    table{ border-collapse:collapse}
    .unit{font-size:smaller;}
    .number{text-align:right;}

    input[type=number]{
      width:70px;
      text-align:right;
    }

    fieldset {
      border-width:1px;
    }
  </style>
</head><body>
<div style="display:flex;justify-content:space-between;border-bottom:1px solid #ccc;margin-bottom:4px">
  <h3>
    State variables editor
    <button onclick=add_flow()>Add flow</button>
    <script>
      function add_flow(){
        let sv = new State_Variables();
        sv.name="New flow";
        if(svs.length){
          sv.Q = svs[svs.length-1].Q;
          Object.keys(sv.components).forEach(key=>{ sv.components[key]=svs[svs.length-1].components[key]; }); 
        }
        svs.push(sv);
        populate();
      }
    </script>
  </h3>
  <div>
    <a href="https://github.com/icra/ecoadvisor/blob/master/state-variables.js" target=_blank>state-variables.js</a>
  </div>
</div>

<!--state variables-->
<div>
  <table id=state-variables border=1>
    <tbody id=inputs></tbody>
    <tr><td colspan=10><small><code>Concentration (mg/L) and mass fluxes (kg/d)</code><small>
    <tbody id=outputs></tbody>
  </table>
</div>

<!--app logic-->
<script src="format.js"></script>
<script src="../state-variables.js"></script>
<script>
  //create and populate all tables
  function populate(){
    //populate inputs
    let inputs=document.querySelector('tbody#inputs');inputs.innerHTML="";
    //populate outputs with the 'totals' calls
    let outputs=document.querySelector('tbody#outputs');outputs.innerHTML="";
    //reset
    if(svs.length==0)return;

    //sv name cell
    let nameRow=inputs.insertRow(-1);
    svs.forEach((sv,i)=>{
      var nameCell=nameRow.insertCell(-1);
      nameCell.colSpan=2;
      nameCell.innerHTML=(i+1)+". ";

      //text box for changing the name
      var input=document.createElement('input');
      input.setAttribute('maxlength',50);
      input.onchange=function(){svs[i].name=this.value};
      nameCell.appendChild(input);
      input.value=sv.name;
      input.placeholder='name';

      //create delete sv button
      var btn_x=document.createElement('button');
      nameCell.appendChild(btn_x);
      btn_x.innerHTML="delete";
      btn_x.onclick=function(){svs.splice(i,1);populate()};
    });

    //inputs
    //flowrate
    {
      let newRow=inputs.insertRow(-1);
      svs.forEach((sv,i)=>{
        newRow.insertCell(-1).innerHTML="Q";
        newRow.insertCell(-1).innerHTML="<input tabindex="+i+" type=number min=0 onchange=svs["+i+"].Q=parseFloat(this.value);redisplay("+i+"); value="+sv.Q+"> <span class=unit>ML/d</span>";
      });
    }
    //components
    Object.keys(svs[0].components).forEach(key=>{
      let newRow=inputs.insertRow(-1);
      svs.forEach((sv,i)=>{
        newRow.insertCell(-1).innerHTML=key;
        newRow.insertCell(-1).innerHTML="<input tabindex="+i+" type=number min=0 onchange=svs["+i+"].components."+key+"=parseFloat(this.value);redisplay("+i+"); value="+sv.components[key]+"> <span class=unit>mg/L</span>";
      });
    });

    //totals and fluxes
    Object.entries(svs[0].totals).forEach(([key,obj])=>{
      let newRow=outputs.insertRow(-1);
      newRow.insertCell(-1).innerHTML=key; //COD
      svs.forEach((sv,i)=>{
        let newCell=newRow.insertCell(-1);
        if(i)newCell.colSpan=2;
        let table=document.createElement('table');table.style.width="100%";table.setAttribute('border',1);table.style.fontSize='smaller';
        newCell.appendChild(table);
        Object.entries(obj).forEach(([key2,val])=>{
          let newRow=table.insertRow(-1);
          newRow.insertCell(-1).innerHTML=key2; //bsCOD
          newRow.insertCell(-1).outerHTML=`<td index=${i} conc key=${key} key2=${key2} class=number>${format(sv.totals[key][key2])}</td>`;
          newRow.insertCell(-1).outerHTML=`<td index=${i} flux key=${key} key2=${key2} class=number>${format(sv.fluxes.totals[key][key2])}</td>`;
        });
      });
    });
  }

  //redisplay values only (call 'totals' for the nth sv)
  function redisplay(n){
    let outputs=document.querySelector('tbody#outputs');
    let totals = svs[n].totals;
    let fluxes = svs[n].fluxes.totals;
    Object.keys(totals).forEach(key=>{
      Object.keys(totals[key]).forEach(key2=>{
        document.querySelector(`td[index='${n}'][conc][key=${key}][key2=${key2}]`).innerHTML=format(totals[key][key2]);
        document.querySelector(`td[index='${n}'][flux][key=${key}][key2=${key2}]`).innerHTML=format(fluxes[key][key2]);
      });
    });
  }
</script>

<!--user-defined-scenario-->
<script>
  /*
    initialize state variables
    create an example with with 3 scenarios: raw ww, sludge and settled ww
  */
  let sv1 = new State_Variables(25,     50, 115, 440,     100, 45,   60, 39.1, 7.28, 0); sv1.name="Raw WW";
  let sv2 = new State_Variables(24.875, 50, 115, 255,      10, 45,   15, 39.1, 7.28, 0); sv2.name="Settled WW";
  let sv3 = new State_Variables(0.125,  50, 115, 37255, 18010, 45, 9015, 39.1, 7.28, 0); sv3.name="Primary Sludge";
  let svs=[sv1, sv2, sv3];
  populate();
</script>
