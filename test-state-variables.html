<!doctype html><html><head>
  <meta charset=utf8>
  <title>State variables</title>
  <style>
    @import url('https://fonts.googleapis.com/css?family=Roboto+Mono:400,700|Roboto:300,400,700');
    body {
      font-family: 'Roboto', verdana;
      color: #5C5C5C;
    }

    table{ border-collapse:collapse}
    table td.unit{font-size:smaller;}

    input[type=number]{
      width:70px;
      text-align:right;
      background:#fafafa;
    }

    fieldset {
      border-width:1px;
    }
  </style>
  <script>
    //UTILS
    /*convert number to formated string: i.e. "3.999,4" instead of 3999.4*/
    function format(number,digits){
      digits=digits||0;
      if(number<1000)digits=1;
      if(number< 100)digits=2;
      if(number<0.10)digits=3;
      if(number<0.01)digits=4;
      digits++;
      let str=new Intl.NumberFormat('en-EN',{maximumFractionDigits:digits}).format(number);
      return str;
    }
  </script>
</head><body>
<div style="display:flex;justify-content:space-between;border-bottom:1px solid #ccc;margin-bottom:4px">
  <h3>
    State variables backend testing
    <button onclick=window.location.reload()>Reset all</button>
  </h3>
  <div>
    Source code: 
    <a href="https://github.com/icra/ecoadvisor/blob/master/state-variables.js" target=_blank>state-variables.js</a>
  </div>
</div>

<div style="display:flex;">
  <!--inputs - state variables-->
  <div>
    <div>1. State variables</div><br>
    <table id=inputs border=1 style=width:100%></table>

    <!--mass ratios-->
    <div style=font-size:smaller;margin-top:8px>
      <div>Mass ratios</div>
      <table id=mass_ratios border=1 style=width:100%></table>
    </div>
  </div>

  <!--totals and fractionation-->
  <div style="border-left:1px solid #ccc;margin-left:8px;padding:0px 4px">
    <div>2. Totals &amp; fractionation (mg/L)</div><br>
    <table id=outputs border=1></table>
  </div>

  <!--techs-->
  <div style="border-left:1px solid #ccc;margin-left:8px;padding:0px 4px" id=techs>
    <div>3. Apply technologies</div><br>
    <style>
      /*units*/
      #techs fieldset table td:nth-child(3){
        font-size:smaller;
      }
      /*apply buttons*/
      #techs button {
        background:lightgreen;
      }
      #techs fieldset {
        margin-bottom:8px;
      }
    </style>

    <fieldset id=primary_settler>
      <legend><a href="//github.com/icra/ecoadvisor/blob/master/primary-settler.js" target=_blank>Primary settler</a></legend>
      <table border=1>
        <tr><td>removal BPO<td><input id=removal_BPO type=number value=57.4257><td class=unit>%
        <tr><td>removal UPO<td><input id=removal_UPO type=number value=86.6667><td class=unit>%
        <tr><td>removal iSS<td><input id=removal_iSS type=number value=66>     <td class=unit>%
      </table>
      <button onclick="apply_pst();this.disabled=true">Apply</button>
      <script>
        function apply_pst(){
          let removal_BPO = parseFloat(document.querySelector('#removal_BPO').value);
          let removal_UPO = parseFloat(document.querySelector('#removal_UPO').value);
          let removal_iSS = parseFloat(document.querySelector('#removal_iSS').value);
          let results = sv.primary_settler(removal_BPO, removal_UPO, removal_iSS);
          redisplay();
          document.querySelector('#primary_settler').appendChild((function(){
            let div=document.createElement('div');
            div.style.fontSize='smaller';
            div.innerHTML="Primary Settler("+removal_BPO+","+removal_UPO+","+removal_iSS+") applied";

            let info=document.createElement('table');
            //info.style.display='none';
            Object.keys(results).forEach(key=>{
              let newRow=info.insertRow(-1);
              newRow.insertCell(-1).innerHTML=key;
              newRow.insertCell(-1).innerHTML=format(results[key].value);
              newRow.insertCell(-1).innerHTML=results[key].unit;
              newRow.setAttribute('title',results[key].descr);
            });

            let info_btn=document.createElement('button');
            info_btn.style.display='block';
            info_btn.innerHTML="Show/Hide Info";
            info_btn.onclick=function(){
              info.style.display=info.style.display=='none'?'':'none';
            };

            div.appendChild(info_btn);
            div.appendChild(info);
            return div;
          })());
        }
      </script>
    </fieldset>

    <fieldset id=bod_removal>
      <legend><a href="//github.com/icra/ecoadvisor/blob/master/bod-removal.js" target=_blank>BOD removal (without nitrification)</a></legend>
      <table border=1>
        <tr><td>BOD <td><input id=BOD type=number value=335.625><td class=unit>mg/L
        <tr><td>Q   <td><input id=Q   type=number value=22700>  <td class=unit>m<sup>3</sup>/d
        <tr><td>T   <td><input id=T   type=number value=12>     <td class=unit>ÂºC
        <tr><td>SRT <td><input id=SRT type=number value=5>      <td class=unit>d
        <tr><td>V   <td><input id=V   type=number value=3000>   <td class=unit>m<sup>3</sup>
        <tr><td>zb  <td><input id=zb  type=number value=500>    <td class=unit>m
        <tr><td>Pr  <td><input id=Pr  type=number value=95600>  <td class=unit>Pa
        <tr><td>Df  <td><input id=Df  type=number value=4.4>    <td class=unit>m
        <tr><td>DO  <td><input id=DO  type=number value=2.0>    <td class=unit>mg/L
      </table>
      <button onclick="apply_bod_removal();this.disabled=true">Apply</button>
      <script>
        function apply_bod_removal(){
          let removal_BPO = parseFloat(document.querySelector('#removal_BPO').value);
          let removal_UPO = parseFloat(document.querySelector('#removal_UPO').value);
          let removal_iSS = parseFloat(document.querySelector('#removal_iSS').value);
          let BOD = parseFloat(document.querySelector('#BOD').value);
          let Q   = parseFloat(document.querySelector('#Q').value);
          let T   = parseFloat(document.querySelector('#T').value);
          let SRT = parseFloat(document.querySelector('#SRT').value);
          let V   = parseFloat(document.querySelector('#V').value);
          let zb  = parseFloat(document.querySelector('#zb').value);
          let Pr  = parseFloat(document.querySelector('#Pr').value);
          let Df  = parseFloat(document.querySelector('#Df').value);
          let DO  = parseFloat(document.querySelector('#DO').value);
          let results = sv.bod_removal(BOD,Q,T,SRT,V,zb,Pr,Df,DO);
          redisplay();
          document.querySelector('#bod_removal').appendChild((function(){
            let div=document.createElement('div');
            div.style.fontSize='smaller';
            div.innerHTML="BOD removal("+BOD+","+Q+","+T+","+SRT+","+V+","+zb+","+Pr+","+Df+","+DO+") applied";

            let info=document.createElement('table');
            //info.style.display='none';
            Object.keys(results).forEach(key=>{
              let newRow=info.insertRow(-1);
              newRow.insertCell(-1).innerHTML=key;
              newRow.insertCell(-1).innerHTML=format(results[key].value);
              newRow.insertCell(-1).innerHTML=results[key].unit;
              newRow.setAttribute('title',results[key].descr);
            });

            let info_btn=document.createElement('button');
            info_btn.style.display='block';
            info_btn.innerHTML="Show/Hide Info";
            info_btn.onclick=function(){
              info.style.display=info.style.display=='none'?'':'none';
            };

            div.appendChild(info_btn);
            div.appendChild(info);
            return div;
          })());
        }
      </script>
    </fieldset>
  </div>
</div>

<!--app logic-->
<script src="utils.js"></script>
<script src="state-variables.js"></script>
<script src="primary-settler.js"></script>
<script src="bod-removal.js"></script>
<script>
  /*Frontend connection with backend*/
  //initialize state variables (global variable)
  let sv=new State_Variables();
  {//populate tables
    //populate state variables table
    let inputs=document.querySelector('table#inputs');
    Object.entries(sv.components).forEach(entry=>{
      let key=entry[0];
      let value=entry[1];
      let newRow=inputs.insertRow(-1);
      newRow.insertCell(-1).innerHTML=key;
      newRow.insertCell(-1).innerHTML="<input id="+key+" type=number min=0 onchange=sv.components."+key+"=parseFloat(this.value);redisplay()>";
      newRow.insertCell(-1).outerHTML="<td class=unit>mg/L";
    });
    let mass_ratios=document.querySelector('table#mass_ratios');
    Object.entries(sv.mass_ratios).forEach(entry=>{
      let key=entry[0];
      let value=entry[1];
      let newRow=mass_ratios.insertRow(-1);
      newRow.insertCell(-1).innerHTML=key;
      newRow.insertCell(-1).innerHTML=value;
    });
  }

  //redisplay inputs and results
  function redisplay(){
    //redisplay inputs
    Object.keys(sv.components).forEach(key=>{
      let value=sv.components[key];
      document.getElementById(key).value=value;
    });

    //redisplay outputs
    let outputs = document.querySelector('#outputs');
    outputs.innerHTML="";
    let results = sv.compute_totals();
    Object.keys(results).forEach(key=>{
      let newRow=outputs.insertRow(-1);
      let value = results[key];
      if(typeof(value)=='number'){
        newRow.insertCell(-1).innerHTML=key;
        newRow.insertCell(-1).innerHTML=format(value);
      }else{
        newRow.insertCell(-1).innerHTML=key;
        let newCell=newRow.insertCell(-1);
        let table=document.createElement('table');table.style.width="100%";table.setAttribute('border',1);
        newCell.appendChild(table);
        Object.keys(results[key]).forEach(k=>{
          let nr=table.insertRow(-1);
          Object.keys(results[key][k]).forEach(kk=>{
            let value=results[key][k][kk];
            nr.insertCell(-1).innerHTML=kk+": <small>"+format(value)+"</small>";
          });
        });
      }
    });
  }
  redisplay();

  //focus the first input element you find
  document.querySelector("input[type=number]").focus();
</script>

<hr><div style=margin-top:8px>
  Items to discuss with George Ekama:
  <ul>
    <li>
      For table 2 I've used the notation of M&amp;EA because it is the one I'm used to, but we can change it to a std one (check <a href="docs/SYMBOLES.XLSX">spreadsheet from Yves Comeau</a>).
    <li>
      In BOD removal: the ratio for calculating nbVSS (pCOD/VSS): shouldn't we get the same exact number as uVSS from table 2?
    <li>
      bCOD at the effluent = S = Ks*(1+bHT*SRT)/(SRT*(mu_mT-bHT)-1);<br>
      how to divide among VFA + FBSO (bsCOD==BSO) + bpCOD (==BPO)?<br>
      for now, I assumed that VFA_eff=0 and FBSO_eff=0 and BPO_eff=S
  </ul>
</div>
